# 弹墙（暂定名）游戏设计文档

## 核心概念

- **玩法类型**：单人街机式反应游戏。
- **目标**：在球坠出场地之前，通过按键临时启用下边墙让球反弹，尽可能维持连击次数。
- **节奏感**：球每次在实化的下边墙反弹都会加速，音高以半音递增，形成紧张、逐渐升级的节奏。

## 交互规则

1. 球体在封闭方框内弹跳。上、左、右三面为永久实墙，自动反弹。
2. 下边墙默认为虚化状态（透明），球可穿透。玩家按住 `确认`（默认空格/回车）时，下边墙立即实化并可反弹球。
   - 底墙在淡出阶段仅当透明度不低于 `0.6` 时仍具有碰撞体，该阈值由 `scripts/game_manager.gd` 中的 `@export var bottom_bounce_alpha_threshold` 控制，亦可在 Inspector 面板直接调整。

- 底墙满亮的保持时间与随后的淡出时长分别由 `bottom_active_duration`（默认 `0.1s`）和 `bottom_fade_duration`（默认 `0.2s`）控制，两者同样暴露在 `scripts/game_manager.gd` 顶部，可在 Inspector 上微调；淡出结束后的残余透明度由 `bottom_ghost_alpha` 决定。淡出被纳入冷却流程，成功接球会发放一次性的免冷却令牌，允许玩家在下一次实化时无视冷却计时——无论当时仍处于淡出动画内，还是冷却计时已经启动，只要令牌尚未被消耗，就能立即实化。

- 若该次实墙成功把球弹回场内，会继续播放淡出动画，同时上述免冷却令牌会一直保留到玩家下一次实化为止；再次成功则刷新新的令牌。若选择不使用或这次接球失败，立即回到 `bottom_rearm_cooldown`（默认 `0.1s`）与 `bottom_rearm_cooldown_min`（默认 `0s`）之间的动态冷却。随着球速提升（连击未重置时），冷却会在这两个值之间线性压缩，当球速因第 20 次连击复位时冷却也回到基准值。

3. 每次在实化的下边墙反弹：
   - 球速提升一个固定倍率。
   - 触发比上一次高半音的提示音。
   - 连击数达到 20 的倍数时，会把球速与音高同时重置到初始值，避免节奏失控。
4. 按键长按现在分为三个阶段：
   - 0 ~ 0.3 秒：保持常速（1×）。
   - 0.3 秒瞬间切换到 2×。
   - 0.3 ~ 0.8 秒：在 0.5 秒的区间内从 2× 线性加速到 2.5×，0.8 秒后保持 2.5×；中途松开会立即回到常速。
5. 若球越界（未能用实化墙接住），会重置至场地中央并恢复初始速度、音调。
6. 开局（0 分）仅保留尖刺指示器，不会提前伸出障碍，让第一颗球拥有完全空旷的内场。随后每次在底墙成功反弹后，当前障碍会像抽屉一样缩回其所属的墙面，新的障碍才会从另一侧墙体缓慢伸出并伴随轻微回弹，始终只存在一个障碍。障碍开始伸出时，会立即在下一堵墙面生成尖刺指示器，提醒玩家下一次抽屉的位置。
7. 场地保持为屏幕中央的正方形区域，下墙默认虚化但保持直线，与其他墙体厚度一致。

## 关卡阶段（每 20 分为一段）

- **Stage 1：0 ~ 19 分（默认静态）**
  - 场地保持完全静止，作为基础练习阶段。
- **Stage 2：20 ~ 39 分（旋转 + 游走）**
  - 整个方框（含三侧墙与动态障碍）会围绕屏幕中心做正向或反向的连续旋转，单次旋转角度收束在 90° ~ 210° 之间，采用慢 → 快 → 慢的缓动节奏，保持易读性。
  - 与旋转同步，还会沿水平方向左右游走，目标偏移量控制在可用空间约 82% 的范围内，单段补间时长收敛到 1.1 ~ 3.7 秒，并以相同的慢 → 快 → 慢节奏推进；偏移方向不会抖动，而是依据当前位置挑选新的目标点，完成后再随机下一段运动。
  - 进入该阶段时会把球重新发射到场地中心，并暂时关闭浅角纠正机制，确保在舞台平移/旋转时球体沿墙自然滑动；阶段退出后恢复默认设置。框体的旋转与平移仅影响墙体与障碍的位置，球体仍然坚持基于实物碰撞的弹跳：只有在碰撞瞬间才会根据墙体法线重新计算出射角，未与墙体接触时不受舞台运动影响。
- **Stage N（40 分以上）**
  - 预留扩展位，可继续叠加新的舞台玩法（例如打砖块、切割场景、随机风向等）。当前阶段结构已按“每 20 分一关”设计，可持续填充至 50+ 关而无需推翻架构。

## 关卡顺序草案

- 第一阶段固定为基础款（`StageStaticArena`，简称 A）。
- 第二阶段起可以从所有“非 A”关卡中随机抽取，例如：旋转游走（`StageRotatingArena`，简称 B）、打砖块（规划中）、贪吃蛇（规划中）等。
- 若需保证不重复，可采用“抽到即暂存、下一阶段从剩余池继续抽取”的方式，直到轮完所有关卡再重置池子。
- `StageManager` 已支持自定义顺序与随机抽选：可通过运行期调用 `developer_configure_stage_sequence([...])` 安排本局的阶段列表，也可利用关卡覆盖接口将某个 Stage 锁定在当前阶段。

## 练习与调试流程

- 若想直接跳到指定关卡练习，在 Godot 播放或 Remote 模式下选中 `GameManager` 节点，执行 `developer_jump_to_stage("stage_rotating_arena")` 等方法即可。
  - 默认会锁定该关卡（后续每 20 分仍停留在同一 Stage），如需只跳转一次，可传入 `lock_stage = false`。
  - 如需恢复正常顺序，可调用 `developer_clear_stage_override()`。
- 也可以在 Inspector 中设置 `debug_initial_stage_id`（例如 `"stage_rotating_arena"`），游戏启动后会自动重置并跳到目标关卡。
- 若要批量排列一个自定义顺序（例如 A → B → C），可调用 `developer_configure_stage_sequence(["stage_static_arena", "stage_rotating_arena", "stage_brick_breaker"])`，完成练习后使用 `developer_clear_stage_sequence_override()` 恢复默认。

## 视觉与音效

- **背景**：纯黑。
- **球与墙体**：纯白，使用程序化绘制，碰撞盒与视觉尺寸一致。球在浅角纠正的缓冲阶段会保持纯白外观，但叠加轻微抖动与手绘噪线以强调危险状态。
- **虚化墙**：保持同样轮廓，但透明度降低（约 30%）。
- **障碍**：与墙体厚度相同的纯白小墙，从上/左/右墙向场地内部延伸，带有伸缩动画和轻微回弹。受击后颜色会以快入慢出的方式渐变为偏红色调；累计三次受击后沿与普通收回一致的抽屉动画退场，并伴随淡红渐隐。
- **尖刺指示器**：当新的障碍开始抽出时，在下一堵目标墙体内侧即时弹出小型三角尖刺，带有快速伸缩动画并指向场地内部，用于提示下一次障碍位置。
- **界面**：中央悬浮透明数字显示连击次数，每次底墙反弹时屏幕产生短暂模糊与闪光，并将数字递增；模糊的峰值强度与球速相关，速度越快闪光越明显。模糊上限可通过 `scripts/game_manager.gd` 的导出变量 `combo_blur_max_intensity` 调整（默认 `0.35`）。
- **UI**：保持极简，默认不显示多余元素，仅在重置时短暂闪烁提示（后续迭代）。
- **音效**：使用合成正弦波短音，依据底部反弹次数逐次提高半音，形成不断爬升的音阶。

## 可玩原型范围

- 单一关卡，屏幕尺寸固定。
- 球速、加速倍率、音阶起始值可在 Inspector 调整。
- 最多生成 3 个障碍物，刷新于每次重置。
- 未实现分数/排行榜，仅记录连击次数（显示在调试输出）。

## 后续扩展想法

- 根据连击次数改变背景音景与视觉特效。
- 加入多种障碍形状与动态移动障碍。
- 增设失败反馈与复位动画。
- 引入渐进式关卡或节奏谱面。
