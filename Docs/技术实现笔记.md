# 弹墙原型 - 技术实现笔记

## 架构概览

- `GameManager`（挂在根节点 `Node2D` 上）：负责初始化正方形场地、驱动单一动态障碍、处理输入、控制底部墙状态、音效与屏幕/数字反馈，并维护底墙的状态机（虚墙 → 实墙 → 透明淡出），淡出阶段根据透明度阈值决定是否仍可弹球。
- `Ball`（`CharacterBody2D`）：使用手动速度向量结合 `move_and_collide` 完成反弹逻辑，向 `GameManager` 报告底部墙反弹与越界事件。底墙命中时完全遵循几何反射结果，仅通过空间分离与坐标夹紧把球即时推回场内（未来即便底墙被旋转到左右侧也成立），同时在离开底墙前不再重复判定（结合短帧冷却与持续接触检测），对障碍亦采用逐帧接触去重，避免同一帧多次计数。当球在玩家操控墙上方以小于 45° 的夹角滑行超过 1 秒时，会进入“扰动”预警：球体保持纯白基色，但会伴随随机抖动与手绘风噪线，持续 1.5 秒并在结束瞬间把切线夹角拉回到“远离玩家墙表面”的 60° 方向（即始终沿控制墙外法线的正向），随后触发一次子弹时间（时间减速后再平滑恢复）。所有碰撞——无论墙壁还是障碍——都会广播一次碰撞事件供 `GameManager` 播放金属“叮”声；底墙连击数每逢 20 的倍数会把球速重置为初始值，同时把 Shepard 音阶回卷到起点，避免无限加速与音高溢出。
- `ObstacleSegment`（`StaticBody2D`）：自绘纯白抽屉式小墙，支持 `extend_to` 与 `retract` 动画；新增命中反馈与 `shatter` 行为，累计三次撞击后碎裂并折叠隐藏，等待下一次底墙命中时才重新抽出并换位。底墙触发时旧障碍会回收、新障碍会立刻在新位置同步伸出，并确保两次位置至少相隔一个墙体厚度，避免重叠。
- `SpikeIndicator`（`StaticBody2D`）：用于提前指示下一堵障碍墙伸出的方位。每当新的障碍开始从墙面伸出时就同步生成下一份配置，将尖刺移动到新的随机位置并触发弹性“冒出”动画；对应旧配置的尖刺会先行缩回。尖刺占满单个墙厚 tile，方向始终指向场地内部，具备轻量碰撞体但不会造成伤害，且始终避开玩家可操控的底墙。
- 所有几何元素使用代码构建：StaticBody2D + Collision（矩形）+ `Polygon2D` 纯色绘制，碰撞与视觉一致。
- 音频通过 `AudioStreamGenerator` 实时合成短促正弦波，并在写入缓冲前检查剩余帧，避免活跃缓冲被强制清空。屏幕模糊叠层使用 `flash_blur` 着色器挂在最上层 `ColorRect` 上，确保包括数字 HUD 在内的所有画面统一受影响；同一着色器还额外提供 `freeze_amount` 参数，在子弹时间期间覆盖一层冷冻感的蓝色泛光与轻度去饱和效果，并在时间恢复时平滑淡出。

## 关键参数

- 场地尺寸：正方形，默认边长 `640 px`，运行时根据窗口居中计算。
- 墙体厚度：`20 px`。
- 初始球速：`440 px/s`；底部反弹加速倍率：`1.08`。连击数每满 20 次会把球速与 Shepard 音阶回归初始值，随后重新开始加速/升调循环。
- 底墙透明度节奏：实墙持续 `bottom_active_duration` 秒后进入 `bottom_fade_duration` 的淡出；淡出期透明度高于 `bottom_bounce_alpha_threshold`（默认 `0.6`）时仍判定反弹，低于阈值后完全失效。
- 音色：基于 `AudioStreamGenerator` 的双正弦叠加（金属风格）。每次碰撞都会写入一次短促的衰减波，主频围绕 `base_frequency` 在约 120 ~ 4200 Hz 间做随机抖动，并混入不同比例的非整数倍泛音以模拟金属质感；底墙 Shepard 音阶在每次触底时读取 `_current_frequency` 输出短促上行音符，并在第 20 次命中回落至 `base_frequency`。

## 随机元素

- 障碍：仅生成 1 个，随机从上/左/右墙抽屉式伸出，厚度与墙体一致，延伸长度范围为墙厚 `×2.5` 至内腔宽度（或高度）的 `55%`；垂直位置直接覆盖整个内腔高度（仅按半厚度防止穿越墙体）。当障碍被击中三次后将保持收回状态，直到球再次触发底墙时才重新随机配置并伸出；每次重生时会同时回收旧障碍并立即弹出新障碍，且新旧位置至少错开一个墙体厚度，避免重叠卡住。尖刺指示器在旧障碍抽回的同时缩回，并在新障碍生效的同一帧跳到下一随机位置，以便玩家提前规划。
- 每次球越界重置时重新生成上述随机障碍。

## 输入映射

- 使用内置 `ui_accept` 行为（空格、回车、手柄 A）。单次触发会立刻让底墙实化一段时间，随后自动进入透明淡出阶段；淡出完成之前禁止再次激活（节流防连打）。

## 待办与风险

- 屏幕爆速模糊现改成 RGB 偏移 + 顺向拉伸，多次采样 `SCREEN_TEXTURE`，低端 GPU 可能吃紧；必要时考虑缩减采样或降分辨率。
- 底墙定时释放依赖 `Timer`，暂停/快进等状态暂未覆盖，后续如加暂停需同步重置。
- UI 仍为简单数字反馈，若要展示伤害或节奏机制需追加设计。
