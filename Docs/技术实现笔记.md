# 弹墙原型 - 技术实现笔记

## 架构概览

- `GameManager`（挂在根节点 `Node2D` 上）：负责初始化正方形场地、驱动单一动态障碍、处理输入、控制底部墙状态、音效与屏幕/数字反馈，并维护底墙的状态机（虚墙 → 实墙 → 透明淡出）。淡出被视作冷却流程的一部分，成功接球会发放“一次性”免冷却窗口，解除底墙的冷却阻塞，可在随后的任意时刻（淡出动画期间或冷却计时已开始时）立即重实化；窗口在下一次实化后立刻消耗，若本次接球失败则直接回到速度驱动的动态冷却。按住 `ui_accept` 0.3 秒会立刻进入 2× 时间倍率，之后在 0.3 ~ 0.8 秒区间线性爬升至 2.5×，再次松开立即回到常速；底墙模糊闪光的峰值强度会根据球当前速度（相对初始速度）线性提升，速度尚低时模糊强度为零，上限由导出变量 `combo_blur_max_intensity`（默认 `0.35`）控制。同时把墙体与障碍整体挂在 `ArenaMotionRoot` 下方，便于关卡状态统一驱动整块场景的旋转与平移。
- `StageManager`（`RefCounted`）：采用**状态模式（State Pattern）**管理“每 20 分一个阶段”的关卡逻辑，内部固定 `points_per_stage = 20`（与 Combo 重置阈值保持一致）。默认基于注册顺序构建阶段序列，并维护 `override` 标志与可选的自定义顺序，负责调用阶段的 `enter` / `exit` / `process`，并向阶段广播分数与舞台边界的变更。默认注册两个阶段：静态舞台与旋转游走舞台；后续只需追加新 Stage 类并注册即可扩展到 50+ 关。
- `Ball`（`CharacterBody2D`）：使用手动速度向量结合 `move_and_collide` 完成反弹逻辑，向 `GameManager` 报告底部墙反弹与越界事件。底墙命中时完全遵循几何反射结果，仅通过空间分离与坐标夹紧把球即时推回场内（未来即便底墙被旋转到左右侧也成立），同时在离开底墙前不再重复判定（结合短帧冷却与持续接触检测），对障碍亦采用逐帧接触去重，避免同一帧多次计数。当球在玩家操控墙上方以小于 40° 的夹角滑行超过 1 秒时，会进入“扰动”预警：球体保持纯白基色，但会伴随随机抖动与手绘风噪线，持续 1.5 秒并在结束瞬间把切线夹角拉回到“远离玩家墙表面”的 60° 方向（即始终沿控制墙外法线的正向），随后触发一次子弹时间（时间减速后再平滑恢复）。该阈值由 `scripts/ball.gd` 顶部常量 `SHALLOW_ANGLE_THRESHOLD_DEG` 控制，可按需调整；滑行/反弹的判定门槛亦收紧到 `SLIDE_NORMAL_THRESHOLD = 48` 与 `SLIDE_WORLD_THRESHOLD = 22`，避免中速撞墙被误判为滑行。所有碰撞——无论墙壁还是障碍——都会广播一次碰撞事件供 `GameManager` 播放金属“叮”声；底墙连击数每逢 20 的倍数会把球速重置为初始值，同时把 Shepard 音阶回卷到起点，避免无限加速与音高溢出。旋转游走阶段会在进入时临时关闭浅角纠正逻辑，以免舞台自身运动造成人工抖动，阶段结束后再自动恢复默认设置。
- `ObstacleSegment`（`StaticBody2D`）：自绘纯白抽屉式小墙，支持 `extend_to` 与 `retract` 动画；命中时会按照当前伤害比例以 0.38 秒的快入慢出补间渐变至目标红色调，避免突兀跳色。累计三次撞击后调用 `shatter`，其本体沿与普通收回一致的三段 `retract` 动画退场，同时叠加淡红渐隐，不再先瞬间清零长度，视觉表现与普通抽屉收回保持一致。底墙触发时旧障碍会回收、新障碍会立刻在新位置同步伸出，并确保两次位置至少相隔一个墙体厚度，避免重叠。
- `SpikeIndicator`（`StaticBody2D`）：用于提前指示下一堵障碍墙伸出的方位。每当新的障碍开始从墙面伸出时就同步生成下一份配置，将尖刺移动到新的随机位置并触发弹性“冒出”动画；对应旧配置的尖刺会先行缩回。尖刺占满单个墙厚 tile，方向始终指向场地内部，具备轻量碰撞体但不会造成伤害，且始终避开玩家可操控的底墙。
- 所有几何元素使用代码构建：StaticBody2D + Collision（矩形）+ `Polygon2D` 纯色绘制，碰撞与视觉一致。
- 音频通过 `AudioStreamGenerator` 实时合成短促正弦波，并在写入缓冲前检查剩余帧，避免活跃缓冲被强制清空。屏幕模糊叠层使用 `flash_blur` 着色器挂在最上层 `ColorRect` 上，确保包括数字 HUD 在内的所有画面统一受影响；着色器仅保留 `intensity` 和 `freeze_amount` 两个参数，分别用于底墙高频模糊闪光与子弹时间的冻结泛光。

## 关卡状态系统

- **设计模式**：采用经典状态模式。`StageManager` 在初始化时会把注册的 Stage（按起始分数升序）记为默认序列，并根据 `points_per_stage` 计算当前分段索引；当连击更新时取序列中对应 Stage 并驱动其生命周期。每个 Stage 通过统一接口暴露 `enter(context) / exit() / process(delta)`，还可以按需覆写 `on_score_changed()` 与自定义回调，确保阶段间完全解耦。
- **共享上下文**：`StageContext`（`scripts/stages/stage_context.gd`）对外暴露 `arena_root`（包含全部墙体与障碍的运动根节点）、`walls_container`、`obstacles_container`、随机数生成器、以及屏幕剩余横向余量（用于限制左右游走幅度）。它还托管 `create_tween()`、`reset_arena_transform()`、`clamp_arena_horizontal_position()` 等便捷方法，所有 Stage 都从此处获取只读/可写资源，避免直接依赖 `GameManager` 的内部字段。
- **阶段实现**：
  - `StageStaticArena`（Stage 1，0~19 分）：进入即将舞台归零，保持墙体静止。
  - `StageRotatingArena`（Stage 2，20~39 分）：进入后生成两组 tween，分别驱动舞台旋转与水平游走。每个 tween 都使用 `Tween.TRANS_SINE + EASE_IN_OUT` 实现“慢 → 快 → 慢”的节奏；旋转单次角度范围更新为 90°~210°，方向随机交替；游走目标限制在可用横向空间的约 82% 以内，水平方向的单段补间时长收敛到 1.1~3.7 秒，若当前靠近一侧则优先朝另一侧移动，并在此范围内随机挑选新的目标偏移。同时会把球重新发射到场地中心并暂时禁止浅角纠正，让球体在旋转/平移动画期间完全依赖真实碰撞自然滑动；阶段退出时恢复默认设置。
- **扩展方式**：新关卡只需编写继承自 `StageBase` 的脚本，并在 `GameManager._initialize_stage_system()` 里 `register_stage(起始分数, StageClass.new())` 即可。若未来需要多资源组合（例如粒子雨、打砖块），推荐在 Stage 内部自行实例化/缓存节点，退出时清理并把舞台 transform 复位。
- **运行时行为**：连击每逢 20 的倍数触发 `StageManager.on_score_changed()`，依据“当前分数 ÷ 20”得到的索引从序列中挑选 Stage；当存在自定义序列时优先使用自定义顺序，若设置了 override 则始终锁定对应 Stage。越界重置会清零连击并回到默认首个 Stage。窗口尺寸变化时 `GameManager` 会重新计算 `arena_rect` 和可用横向空间，并通过上下文回调刷新当前 Stage 的运动限制。
- **随机/乱序支持**：外部脚本可调用 `developer_configure_stage_sequence([...])` 传入任意 Stage ID 序列（去重后生效），用于一次性排定当前局的关卡顺序；同样提供 `developer_clear_stage_sequence_override()` 恢复默认顺序。若需要“抽到即锁定”训练，可使用 `developer_jump_to_stage(stage_id)` 设置 override 并在训练结束后执行 `developer_clear_stage_override()`。

### 调试接口

- `developer_list_stage_ids()`：返回当前已注册的 Stage ID 列表（默认 `["stage_static_arena", "stage_rotating_arena"]`）。
- `developer_jump_to_stage(stage_id, lock_stage := true, restart_stage := true)`：重置整局并跳到指定关卡；默认会锁定 Stage（后续 20 分仍保持同一关），可通过 `lock_stage = false` 实现一次性跳转。
- `developer_clear_stage_override()`：取消锁定并根据当前连击数重新计算关卡。
- `developer_configure_stage_sequence([...])` / `developer_clear_stage_sequence_override()`：设置或清除一次性的乱序序列；调用后立即刷新当前关卡。
- `debug_initial_stage_id`（导出变量）：在编辑器 Inspector 中填写 Stage ID，运行时会自动调用一次 `developer_jump_to_stage`。

## 关键参数

- 场地尺寸：正方形，默认边长 `640 px`，运行时根据窗口居中计算。
- 墙体厚度：`20 px`。
- 初始球速：`440 px/s`；底部反弹加速倍率：`1.08`。连击数每满 20 次会把球速与 Shepard 音阶回归初始值，随后重新开始加速/升调循环。
- 底墙透明度节奏：实墙持续 `bottom_active_duration` 秒（默认 `0.1`）后进入 `bottom_fade_duration` 的淡出段（默认 `0.2`）；淡出期透明度高于 `bottom_bounce_alpha_threshold`（默认 `0.75`）时仍判定反弹，低于阈值后完全失效。若该次实墙成功把球弹回场内，会保留整段淡出动画并发放一个“下一次激活免冷却”的令牌，直到玩家再次实化前都可以消费；再次成功则刷新新的令牌，如若没接到球则立即回到动态冷却。两者同样可在 `GameManager` Inspector 中调整，`bottom_ghost_alpha` 维持幽灵态透明度。
- 音色：基于 `AudioStreamGenerator` 的双正弦叠加（金属风格）。每次碰撞都会写入一次短促的衰减波，主频围绕 `base_frequency` 在约 120 ~ 4200 Hz 间做随机抖动，并混入不同比例的非整数倍泛音以模拟金属质感；底墙 Shepard 音阶在每次触底时读取 `_current_frequency` 输出短促上行音符，并在第 20 次命中回落至 `base_frequency`。

## 随机元素

- 障碍：开局（0 分）场内仅保留尖刺指示器，不会生成实体障碍；仅在玩家首次成功反弹后才伸出第一堵抽屉墙。此后仍只生成 1 个障碍，随机从上/左/右墙抽屉式伸出，厚度与墙体一致，延伸长度范围为墙厚 `×2.5` 至内腔宽度（或高度）的 `55%`；垂直位置直接覆盖整个内腔高度（仅按半厚度防止穿越墙体）。当障碍被击中三次后将保持收回状态，直到球再次触发底墙时才重新随机配置并伸出；每次重生时会同时回收旧障碍并立即弹出新障碍，且新旧位置至少错开一个墙体厚度，避免重叠卡住。尖刺指示器在旧障碍抽回的同时缩回，并在新障碍生效的同一帧跳到下一随机位置，以便玩家提前规划。
- 每次球越界重置时重新生成上述随机障碍。

## 输入映射

- 使用内置 `ui_accept` 行为（空格、回车、手柄 A）。单次触发会立刻让底墙实化一段时间，随后若成功接到球会继续播放淡出动画，并发放一个“下一次激活免冷却”的令牌；令牌只在下一次实化时消耗，因而可以在淡出或冷却任意时刻随时呼出底墙。若没接到球，则会按动态冷却（`bottom_rearm_cooldown` ↔ `bottom_rearm_cooldown_min`）等待。按住同一按键 0.3 秒会跳到 2× 时间倍率，并在继续按住的 0.5 秒内线性升至 2.5×，松开即刻恢复常速；该加速与 bullet time 的减速因子相乘，二者可同时生效。

## 调整窗口尺寸

- 如需扩大主窗口，请在 Godot 编辑器中打开 **Project Settings → Display → Window → Size**，调整 `Viewport Width/Height` 或 `Window Width/Height`；对应设置会写入 `project.godot` 的 `[display/window]` 段落，也可直接在该文件中编辑相同键值。

## 待办与风险

- 屏幕爆速模糊现改成 RGB 偏移 + 顺向拉伸，多次采样 `SCREEN_TEXTURE`，低端 GPU 可能吃紧；必要时考虑缩减采样或降分辨率。
- 底墙定时释放依赖 `Timer`，暂停/快进等状态暂未覆盖，后续如加暂停需同步重置。
- UI 仍为简单数字反馈，若要展示伤害或节奏机制需追加设计。
